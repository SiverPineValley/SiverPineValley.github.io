{"componentChunkName":"component---src-templates-blog-post-js","path":"/Golang/concurrency_3/","result":{"data":{"site":{"siteMetadata":{"title":"Devlog"}},"markdownRemark":{"id":"fa35571b-9465-5a72-9bee-220d118cc9c9","excerpt":"…","html":"<p>앞서 배운 병행 처리 코드를 다양하게 활용하여 네 가지 패턴을 만들어보았다.</p>\n<table>\n<thead>\n<tr>\n<th>활용</th>\n<th>내용</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>타임아웃</td>\n<td>시간이 오래 걸리는 작업에 타임아웃 처리하기</td>\n</tr>\n<tr>\n<td>공유 메모리</td>\n<td>채널을 사용하여 여러 고루틴의 공유 메모리 접근 제어하기</td>\n</tr>\n<tr>\n<td>파이프라인</td>\n<td>여러 고루틴을 파이프라인 형태로 연결하기</td>\n</tr>\n<tr>\n<td>맵 리듀스</td>\n<td>고루틴을 사용하여 맵리듀스 패턴 구현하기</td>\n</tr>\n</tbody>\n</table>\n<h1>1. 타임아웃</h1>\n<p>시간이 오래 걸리는 작업에 select문을 사용하면 타임아웃 기능을 쉽게 구현할 수 있다.\n아래 소스 코드는 채널을 사용하여 타임아웃 패턴을 구현하였다.\nprocess 함수 내에서 타임아웃이 되기 전에 작업이 끝나면 done 채널에 메시지가 먼저 전달되어 select 문에서 done 케이스가 먼저 실행된다.\n반대로, 타임아웃이 되면 process 함수 내로 quit 채널에 값이 전달되어 함수가 그대로 종료된다.</p>\n<p>이렇게 구현된 이유는 먼저, process 내에서 quit 채널에 대한 처리를 하지 않는다면 타임아웃되더라도 done 채널은 그대로 동작한다.\n물론, 엄마 함수가 메모리에서 제거되었기 때문에 done 채널에 값은 전달되어도 그냥 무시된다.</p>\n<p>만약, 타임아웃 되었을 때 done 채널을 닫으면(close) done 채널이 전달될 때 런타임 에러(panic: send on closed channel)이 발생한다.\n타임아웃으로 done 채널을 닫을 때는 process() 함수에서 done 채널은 외부에서 닫힐 수 있다는 것을 고려해야 한다.</p>\n<p>예제처럼 process()함수에 quit 채널을 전달해주면, 에러 처리를 별도로 하지 않더라도 정상 동작이 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"fmt\"</span>\n    <span class=\"token string\">\"time\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    quit <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    done <span class=\"token operator\">:=</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span>quit<span class=\"token punctuation\">)</span>\n    timeout <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">After</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">select</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> d <span class=\"token operator\">:=</span> <span class=\"token operator\">&lt;-</span>done<span class=\"token punctuation\">:</span>\n        fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">case</span> <span class=\"token operator\">&lt;-</span>timeout<span class=\"token punctuation\">:</span>\n        quit <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n        fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Time out!!\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span>quit <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">chan</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">{</span>\n    done <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            time<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span> <span class=\"token comment\">// heavy job</span>\n\n            done <span class=\"token operator\">&lt;-</span> <span class=\"token string\">\"Complete !!\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">&lt;-</span> quit\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> done\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1>2. 공유 메모리</h1>\n<p>여러 스레드에서 공유 메모리를 사용할 때는 보통 스레드 하나에서 공유 메모리에 접근하는 것을 보장하기 위해 Critical Section의 코드를 실행 하기 전에 Mutex를 잠그고, 처리를 완료한 후에 해제한다. 이전에 배운바와 같이 Go에서도 sync 패키지를 사용하여 Mutex를 사용할 수 있다.</p>\n<p>하지만, Go는 메모리를 공유하는 방식이 아니라 채널을 통해 메시지를 전달하는 방식으로 여러 고루틴간의 동기화를 권장한다.\n본 장에서는 공유 메모리를 구현하기 위해 아래와 같은 구조체를 정의하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">(</span>\n    set <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span>\n    get\n    remove\n    count\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> SharedMap <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    m <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    c <span class=\"token keyword\">chan</span> commond\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> command <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    key <span class=\"token builtin\">string</span>\n    value <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    action <span class=\"token builtin\">int</span>\n    result <span class=\"token keyword\">chan</span><span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>SharedMap 내부에서는 실제 맵 정보를 가리키는 <code class=\"language-text\">m m[string]interface{}{}</code> 필드와 채널을 통해 SharedMap에 명령을 전달할 <code class=\"language-text\">c chan command</code> 필드가 있다.\nkey와 value, 수행할 액션을 나타내는 action을 command 구조체에 담아 채널로 전달하고, 처리 결과는 command 구조체의 result 채널로 확인한다.\nresult는 결과를 전송달하기 위한 용도로만 사용되므로, 송신 전용 채널 (chan&#x3C;-)으로 정의했다.</p>\n<p>command의 action으로 사용할 값은 코드 상부의 상수로 정의한다.\n위 사전 정의된 내용을 사용하여 아래와 같이 공유 메모리 예제를 구현할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">import</span> <span class=\"token string\">\"fmt\"</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>sm SharedMap<span class=\"token punctuation\">)</span> <span class=\"token function\">Set</span><span class=\"token punctuation\">(</span>k <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> v <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>r <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    callback <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    sm<span class=\"token punctuation\">.</span>c <span class=\"token operator\">&lt;-</span> command<span class=\"token punctuation\">{</span>action<span class=\"token punctuation\">:</span> set<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">:</span> k<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> v<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">:</span> callback<span class=\"token punctuation\">}</span>\n    r <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;-</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>sm SharedMap<span class=\"token punctuation\">)</span> <span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>k <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>v <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> r <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    callback <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    sm<span class=\"token punctuation\">.</span>c <span class=\"token operator\">&lt;-</span> command<span class=\"token punctuation\">{</span>action<span class=\"token punctuation\">:</span> get<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">:</span> k<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">:</span> callback<span class=\"token punctuation\">}</span>\n    result <span class=\"token operator\">:=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;-</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    v <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    r <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>sm SharedMap<span class=\"token punctuation\">)</span> <span class=\"token function\">Remove</span><span class=\"token punctuation\">(</span>k <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>r <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    callback <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    sm<span class=\"token punctuation\">.</span>c <span class=\"token operator\">&lt;-</span> command<span class=\"token punctuation\">{</span>action<span class=\"token punctuation\">:</span> remove<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">:</span> k<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">:</span> callback<span class=\"token punctuation\">}</span>\n    r <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;-</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>sm SharedMap<span class=\"token punctuation\">)</span> <span class=\"token function\">Count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>r <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    callback <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    sm<span class=\"token punctuation\">.</span>c <span class=\"token operator\">&lt;-</span> command<span class=\"token punctuation\">{</span>action<span class=\"token punctuation\">:</span> count<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">:</span> callback<span class=\"token punctuation\">}</span>\n    r <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;-</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>sm SharedMap<span class=\"token punctuation\">)</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> cmd <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> sm<span class=\"token punctuation\">.</span>c <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> cmd<span class=\"token punctuation\">.</span>action <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> set<span class=\"token punctuation\">:</span>\n                sm<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">[</span>cmd<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> cmd<span class=\"token punctuation\">.</span>value\n                <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> sm<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">[</span>cmd<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">]</span>\n                cmd<span class=\"token punctuation\">.</span>result <span class=\"token operator\">&lt;-</span> ok\n            <span class=\"token keyword\">case</span> get<span class=\"token punctuation\">:</span>\n                v<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> sm<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">[</span>cmd<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">]</span>\n                cmd<span class=\"token punctuation\">.</span>result <span class=\"token operator\">&lt;-</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span>v<span class=\"token punctuation\">,</span> ok<span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">case</span> remove<span class=\"token punctuation\">:</span>\n                <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> sm<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">[</span>cmd<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">]</span>\n                <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>ok <span class=\"token punctuation\">{</span>\n                    cmd<span class=\"token punctuation\">.</span>result <span class=\"token operator\">&lt;-</span> <span class=\"token boolean\">false</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">,</span> cmd<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span>\n                    <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> ok <span class=\"token operator\">=</span> sm<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">[</span>cmd<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">]</span>\n                    cmd<span class=\"token punctuation\">.</span>result <span class=\"token operator\">&lt;-</span> <span class=\"token operator\">!</span>ok\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">case</span> count<span class=\"token punctuation\">:</span>\n                cmd<span class=\"token punctuation\">.</span>result <span class=\"token operator\">&lt;-</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">NewMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> SharedMap <span class=\"token punctuation\">{</span>\n    sm <span class=\"token operator\">:=</span> SharedMap<span class=\"token punctuation\">{</span>\n        m<span class=\"token punctuation\">:</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        c<span class=\"token punctuation\">:</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">go</span> sm<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> sm\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    m <span class=\"token operator\">:=</span> <span class=\"token function\">NewMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Set item</span>\n    ok <span class=\"token operator\">:=</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"bar\"</span><span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>ok<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Get item</span>\n    t<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Check if item exists</span>\n    <span class=\"token keyword\">if</span> ok <span class=\"token punctuation\">{</span>\n        bar <span class=\"token operator\">:=</span> t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span>\n        fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bar: \"</span><span class=\"token punctuation\">,</span> bar<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Remove item</span>\n    ok <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">Remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">)</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>ok<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Count item</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Count: \"</span><span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">Count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1>3. 파이프라인</h1>\n<p>유닉스에서는 셸 명령어를 파이프라인(|)으로 연결할 수 있다. 파이프를 통해 셸 명령어를 실행하면 파이프 이전 명령어의 output이 파이프 이후 명령어의 input으로 입력된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">find</span> src <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> .go$ <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span></code></pre></div>\n<p>위 명령은 src 디렉터리의 파일 중 (find src), 파일 이름이 .go로 끝나는 파일을 필터링해서(grep .go$), 파일의 정보를 라인 수와 함께 출력한다. (xargs wc -l)\nGo에서는 기본 라이브러리인 ip.Pipe()를 사용하면 유닉스 스타일로 파이프라인을 생성할 수 있다.\n<code class=\"language-text\">io.Pipe()</code>를 호출하면 <em>PipeReader와</em>PipeWriter가 반환되는데, 두 함수는 내부적으로 연결되어 있어서, <em>PipeReader의 결과가</em>PipeWriter의 입력으로 바로 전달된다. 하지만 <code class=\"language-text\">io.Pipe()</code>는 두 함수간 연결으로만 동작하므로, 다양하게 활용하기에는 제약이 있다.</p>\n<p>위의 스크립트를 고루틴으로 구현하기 위해서는 세 가지 함수 구현이 필요하다.</p>\n<ol>\n<li>find(path string) &#x3C;- chan string</li>\n<li>grep(pattern string, in &#x3C;-chan string) &#x3C;-chan string</li>\n<li>display(in &#x3C;- chan result)</li>\n</ol>\n<p>함수 세 개를 다음과 같이 채널로 연결할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\">path<span class=\"token punctuation\">,</span> pattern <span class=\"token operator\">:=</span> <span class=\"token function\">pargeAgrs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nch1 <span class=\"token operator\">:=</span> <span class=\"token function\">find</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span>\nch2 <span class=\"token operator\">:=</span> <span class=\"token function\">grep</span><span class=\"token punctuation\">(</span>pattern<span class=\"token punctuation\">,</span> ch1<span class=\"token punctuation\">)</span>\n<span class=\"token function\">display</span><span class=\"token punctuation\">(</span>ch2<span class=\"token punctuation\">)</span></code></pre></div>\n<p>find()함수의 결과는 grep() 함수의 매개변수로 전달되고, grep()의 결과는 display()의 매개변수로 전달된다.\n이를 main()에서 아래와 같이 구현이 가능하다. 이를 통해 display()에서 반환한 채널을 대기시켜 전체 작업이 완료될 때 까지 프로그램을 종료시키지 않고 대기시킬 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> Job <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">,</span> log <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">type</span> jobHandler <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>Job<span class=\"token punctuation\">)</span> Job\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>handler jobHandler<span class=\"token punctuation\">,</span> in <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">chan</span> Job<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> Job</code></pre></div>\n<p>이를 모두 이용하면 다음과 같이 구현 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">const</span> BUF_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">1000</span>\n\n<span class=\"token keyword\">var</span> <span class=\"token punctuation\">(</span>\n workers <span class=\"token operator\">=</span> runtime<span class=\"token punctuation\">.</span><span class=\"token function\">NumCPU</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">Find</span><span class=\"token punctuation\">(</span>path <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">{</span>\n out <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> BUF_SIZE<span class=\"token punctuation\">)</span>\n done <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> workers<span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> workers<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   filepath<span class=\"token punctuation\">.</span><span class=\"token function\">Walk</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>file <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> info os<span class=\"token punctuation\">.</span>FileInfo<span class=\"token punctuation\">,</span> err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n    out <span class=\"token operator\">&lt;-</span> file\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span>\n   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n   done <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">}</span>\n <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token function\">cap</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token operator\">&lt;-</span>done\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n <span class=\"token keyword\">return</span> out\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">Grep</span><span class=\"token punctuation\">(</span>pattern <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> in <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">{</span>\n out <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token function\">cap</span><span class=\"token punctuation\">(</span>in<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  regex<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> regexp<span class=\"token punctuation\">.</span><span class=\"token function\">Compile</span><span class=\"token punctuation\">(</span>pattern<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n   fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">for</span> file <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> in <span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">if</span> regex<span class=\"token punctuation\">.</span><span class=\"token function\">MatchString</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    out <span class=\"token operator\">&lt;-</span> file\n   <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">return</span> out\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">Show</span><span class=\"token punctuation\">(</span>in <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>\n quit <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> file <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> in <span class=\"token punctuation\">{</span>\n   c<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">lineCount</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">continue</span>\n   <span class=\"token punctuation\">}</span>\n   fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"8d %s\\n\"</span><span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  quit <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">return</span> quit\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">lineCount</span><span class=\"token punctuation\">(</span>file <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n f<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> err\n <span class=\"token punctuation\">}</span>\n <span class=\"token keyword\">defer</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n info<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">Stat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> err\n <span class=\"token punctuation\">}</span>\n\n <span class=\"token keyword\">if</span> info<span class=\"token punctuation\">.</span><span class=\"token function\">Mode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsDir</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Errorf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s is a directory\"</span><span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">}</span>\n\n count <span class=\"token operator\">:=</span> <span class=\"token number\">0</span>\n buf <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1024</span><span class=\"token operator\">*</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span>\n newLine <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">{</span><span class=\"token char\">'\\n'</span><span class=\"token punctuation\">}</span>\n\n <span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n  c<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token operator\">&amp;&amp;</span> err <span class=\"token operator\">!=</span> io<span class=\"token punctuation\">.</span>EOF <span class=\"token punctuation\">{</span>\n   fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> err\n  <span class=\"token punctuation\">}</span>\n\n  count <span class=\"token operator\">+=</span> bytes<span class=\"token punctuation\">.</span><span class=\"token function\">Count</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>c<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> newLine<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> err <span class=\"token operator\">==</span> io<span class=\"token punctuation\">.</span>EOF <span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">break</span>\n  <span class=\"token punctuation\">}</span>\n <span class=\"token punctuation\">}</span>\n <span class=\"token keyword\">return</span> count<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>    \n runtime<span class=\"token punctuation\">.</span><span class=\"token function\">GOMAXPROCS</span><span class=\"token punctuation\">(</span>runtime<span class=\"token punctuation\">.</span><span class=\"token function\">NumCPU</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n path <span class=\"token operator\">:=</span> <span class=\"token string\">\"/Users/parkjongin/workspace/go/src/golang-practice\"</span>\n pattern <span class=\"token operator\">:=</span> <span class=\"token string\">\".go$\"</span>\n <span class=\"token operator\">&lt;-</span>common<span class=\"token punctuation\">.</span><span class=\"token function\">Show</span><span class=\"token punctuation\">(</span>common<span class=\"token punctuation\">.</span><span class=\"token function\">Grep</span><span class=\"token punctuation\">(</span>pattern<span class=\"token punctuation\">,</span> common<span class=\"token punctuation\">.</span><span class=\"token function\">Find</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"[Go 언어 문법 정리] 04. 병행 처리 (3) 병행 처리 활용","date":"April 16, 2022","description":null}},"previous":{"fields":{"slug":"/Golang/concurrency_2/"},"frontmatter":{"title":"[Go 언어 문법 정리] 04. 병행 처리 (2) 저수준 제어"}},"next":{"fields":{"slug":"/Golang/error/"},"frontmatter":{"title":"[Go 언어 문법 정리] 05. 에러 처리"}}},"pageContext":{"id":"fa35571b-9465-5a72-9bee-220d118cc9c9","previousPostId":"f946c58c-6e86-52f9-b47d-07bf480adb02","nextPostId":"49c81576-a4d4-59bc-b64c-381828f6fba1"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}