{"componentChunkName":"component---src-templates-blog-post-js","path":"/kubernetes/kubernetes_6_1/","result":{"data":{"site":{"siteMetadata":{"title":"Devlog"}},"markdownRemark":{"id":"136e2b60-609d-5eea-8b35-c7dc6cee613b","excerpt":"6.1 서비스 API 카테고리 서비스 API 카테고리는 클러스터상 컨테이너에 대한 엔드포인트를 제공하거나 레이블과 일치하는 컨테이너의 디스커버리에 사용되는 리소스이다. 내부적으로 사용되는 리소스를 제외하고 사용자가 직접 사용하는 것은 L4 로드밸런싱을 제공하는 서비스 리소스와 L…","html":"<h1>6.1 서비스 API 카테고리</h1>\n<p>서비스 API 카테고리는 클러스터상 컨테이너에 대한 엔드포인트를 제공하거나 레이블과 일치하는 컨테이너의 디스커버리에 사용되는 리소스이다. 내부적으로 사용되는 리소스를 제외하고 사용자가 직접 사용하는 것은 L4 로드밸런싱을 제공하는 서비스 리소스와 L7 로드밸런싱을 제공하는 인그레스 리소스가 있다. 또한, 서비스 리소스에는 제공 목적에 따라 클러스터 내부나 클러스터 외부에서 접속할 수 있는, 접속 창구가 되는 가상 IP 등의 엔드포인트를 제공하고 있다. 그리고 제공 목적에 따라 일곱 가지 서비스 타입을 가지고 있다.</p>\n<ul>\n<li>Cluster IP</li>\n<li>External IP(Cluster IP의 한 종류)</li>\n<li>NodePort</li>\n<li>LoadBalancer</li>\n<li>Headless(None)</li>\n<li>ExternalName</li>\n<li>None-Selector</li>\n<li>인그레스</li>\n</ul>\n<h1>6.2 쿠버네티스 클러스터 네트워크와 서비스</h1>\n<p>쿠버네티스 네트워크를 설명하기 전 이전에 설명했던 내용을 다시 한 번 상기시켜보자. 파드 내부에는 여러 컨테이너가 존재할 수 있는데, 하나의 파드 내부의 컨테이너들은 모두 같은 IP주소를 공유한다. 즉, 파드 내부 컨테이너들간의 통신은 localhost로 통신하고, 다른 파드에 있는 컨테이너는 파드의 IP주소로 통신한다.  쿠버네티스 클러스터를 생성하면 노드상에 파드를 위한 내부 네트워크가 자동으로 구성된다. 내부 네트워크 구성은 사용할 CNI(Container Network Interface)라는 플러그형 모듈 구현에 따라 다르지만, 기본적으로 노드별로 다른 네트워크를 구성하고 노드 간 트래픽은 VXLAN이나 L2 Routing 등의 기술로 전송한다. 노드별 네트워크 세그먼트는 쿠버네티스 클러스터 전체에 할당된 네트워크 세그먼트를 자동으로 분할해 할당하므로, 사용자가 설정하지 않아도 된다.</br></p>\n<p>이러한 내부 네트워크가 자동으로 구성되기 때문에 파다는 서비스를 사용하지 않고도 파드 간 통신이 가능하다. 서비스를 사용하면 다음 두 가지 장점을 얻을 수 있다.</p>\n<ul>\n<li>파드에 트래픽 로드 밸런싱</li>\n<li>서비스 디스커버리와 클러스터 내부 DNS</li>\n</ul>\n<h2>6.2.1 파드에 트래픽 로드 밸런싱</h2>\n<p>서비스는 수신한 트래픽을 여러 파드에 로드밸런싱 하는 기능을 제공한다. 디플로이먼트를 사용하여 여러 파드를 구성하면, 각 파드에는 서로 다른 IP주소가 부여되기 때문에 로드 밸런싱 구조를 자체적으로 구현하려면 각 파드의 IP주소를 매번 조회하거나 전송 대상의 목적지를 설정해야 한다. 하지만, 서비스를 사용하면 여러 파드에 대한 로드밸런싱을 자동으로 구현할 수 있다. 또한, 서비스는 로드 밸런싱의 엔드포인트를 제공한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>deployment\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>container\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> amsy810/echo<span class=\"token punctuation\">-</span>nginx<span class=\"token punctuation\">:</span>v2.0</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 디플로이먼트 생성</span>\n$ kubectl apply <span class=\"token parameter variable\">-f</span> sample-deployment.yaml\ndeployment.apps/sample-deployment configured\n\n<span class=\"token comment\"># 생성된 파드 레이블 출력</span>\n$ kubectl get pods <span class=\"token parameter variable\">-o</span> custom-columns<span class=\"token operator\">=</span><span class=\"token string\">\"NAME:{.metadata.name},LABEL:{.metadata.labels}\"</span>\nNAME                                 LABEL\nsample-deployment-65b84c8657-b5795   map<span class=\"token punctuation\">[</span>app:sample-app pod-template-hash:65b84c8657<span class=\"token punctuation\">]</span>\nsample-deployment-65b84c8657-nfhch   map<span class=\"token punctuation\">[</span>app:sample-app pod-template-hash:65b84c8657<span class=\"token punctuation\">]</span>\nsample-deployment-65b84c8657-v244g   map<span class=\"token punctuation\">[</span>app:sample-app pod-template-hash:65b84c8657<span class=\"token punctuation\">]</span>\nsample-pod                           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\n\n<span class=\"token comment\"># 출력 시 특정 JSON Path(예제에서는 레이블) 값만을 출력</span>\n$ kubectl get pods sample-deployment-65b84c8657-b5795 <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">'{.metadata.labels}'</span>\n<span class=\"token punctuation\">{</span><span class=\"token string\">\"app\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sample-app\"</span>,<span class=\"token string\">\"pod-template-hash\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"65b84c8657\"</span><span class=\"token punctuation\">}</span>%</code></pre></div>\n<p>다음으로는, 엔드포인트의 서비스 종류에 ClusterIP를 사용하는 서비스를 생성해보겠다. 서비스 종류는 나중에 자세히 설명하겠지만, ClusterIP는 클러스터 내부에서만 사용 가능한 가상 IP를 가진 엔드포인트를 제공하는 로드 밸런서를 구성한다. 서비스는 <code class=\"language-text\">.spec.selector</code>에 정의할 셀렉터 조건에 따라 트래픽을 전송한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>clusterip\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app</code></pre></div>\n<p>서비스를 생성하면 로드 밸런서의 트래픽이 전송되는 파드를 확인해보자. 먼저 <code class=\"language-text\">app: sample-app</code> 레이블을 가진 파드 IP 주소를 확인해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 서비스 생성</span>\n$ kubectl apply <span class=\"token parameter variable\">-f</span> sample-clusterip.yaml\nservice/sample-clusterip created\n\n<span class=\"token comment\"># 지정한 레이블을 가진 파드 정보 중 특정 JSON Path를 컬럼으로 출력</span>\n$ kubectl get pods <span class=\"token parameter variable\">-l</span> <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>sample-app <span class=\"token parameter variable\">-o</span> custom-columns<span class=\"token operator\">=</span><span class=\"token string\">\"NAME:{metadata.name},IP:{status.podIP}\"</span>\nNAME                                 IP\nsample-deployment-65b84c8657-b5795   <span class=\"token number\">10.244</span>.2.8\nsample-deployment-65b84c8657-nfhch   <span class=\"token number\">10.244</span>.1.8\nsample-deployment-65b84c8657-v244g   <span class=\"token number\">10.244</span>.3.35\n\n<span class=\"token comment\"># 서비스 정보 확인 (엔드포인트: 10.96.214.33)</span>\n$ kubectl get services sample-clusterip\nNAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>    AGE\nsample-clusterip   ClusterIP   <span class=\"token number\">10.96</span>.214.33   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">8080</span>/TCP   46s\n\n<span class=\"token comment\"># 서비스 상세 정보 확인</span>\n$ kubectl describe <span class=\"token function\">service</span> sample-clusterip\nName:              sample-clusterip\nNamespace:         default\nLabels:            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nAnnotations:       <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nSelector:          <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>sample-app\nType:              ClusterIP\nIP Family Policy:  SingleStack\nIP Families:       IPv4\nIP:                <span class=\"token number\">10.96</span>.214.33\nIPs:               <span class=\"token number\">10.96</span>.214.33\nPort:              http-port  <span class=\"token number\">8080</span>/TCP\nTargetPort:        <span class=\"token number\">80</span>/TCP\nEndpoints:         <span class=\"token number\">10.244</span>.1.8:80,10.244.2.8:80,10.244.3.35:80\nSession Affinity:  None\nEvents:            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\n\n<span class=\"token comment\"># 별도 파드를 생성하여 접속</span>\n$ kubectl apply <span class=\"token parameter variable\">-f</span> sample-pod.yaml\npod/sample-pod created\n\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- /bin/bash\n\n<span class=\"token comment\"># 서비스 엔드포인트로 요청</span>\nroot@sample-pod: <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> http://10.96.214.33:8080\n<span class=\"token assign-left variable\">Host</span><span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.214.33  <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/  <span class=\"token assign-left variable\">From</span><span class=\"token operator\">=</span>sample-deployment-65b84c8657-v244g  <span class=\"token assign-left variable\">ClientIP</span><span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.1.9  <span class=\"token assign-left variable\">XFF</span><span class=\"token operator\">=</span></code></pre></div>\n<p>Endpoints 부분에 아무 것도 표시되지 않았을 경우 셀렉터 조건이 맞지 않을 가능성이 있다. 이번 예제에서는 서비스 엔드포인트 타입을 ClusterIP로 설정했기 때문에 가상 엔드포인트는 클러스터 내부에서만 호출 가능하다.</p>\n<h3>여러 포트 할당</h3>\n<p>이전 예제에서는 서비스에 하나의 포트만 할당했었는데, 서비스에 여러 포트를 할당 가능하다. 아래 예제에서는 ClusterIP의 8080 포트를 파드 80포트로, ClusterIP의 8443 포트를 파드 443 포트로 로드밸런싱한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>clusterip<span class=\"token punctuation\">-</span>multi\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https-port\"</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8443</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">443</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app</code></pre></div>\n<h3>이름을 사용한 포트 참조</h3>\n<p>위 예제에서는 <code class=\"language-text\">targetPort</code>를 직접 지정했는데, 파드의 포트 정의에 이름을 지정해 놓으면 이름을 사용하여 참조할 수 있다. 디플로이먼트의 포트 정의에서 80 포트를 http로 명명하고, 서비스에서 참조할 때는 targetPort에서 http를 참조한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>named<span class=\"token punctuation\">-</span>port<span class=\"token punctuation\">-</span>pod<span class=\"token punctuation\">-</span><span class=\"token number\">80</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>container\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> amsy810/echo<span class=\"token punctuation\">-</span>nginx<span class=\"token punctuation\">:</span>v2.0\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> http <span class=\"token comment\"># 포트에 이름 지정</span>\n      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>named<span class=\"token punctuation\">-</span>port<span class=\"token punctuation\">-</span>pod<span class=\"token punctuation\">-</span><span class=\"token number\">81</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>container\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> amsy810/echo<span class=\"token punctuation\">-</span>nginx<span class=\"token punctuation\">:</span>v2.0\n    <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> NGINX_PORT\n      <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"81\"</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> http <span class=\"token comment\"># 포트에 이름 지정</span>\n      <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">81</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>named<span class=\"token punctuation\">-</span>port<span class=\"token punctuation\">-</span>service\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n    <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> http\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 파드 생성</span>\n$ kubectl apply <span class=\"token parameter variable\">-f</span> sample-named-port-pods.yaml\npod/sample-named-port-pod-80 created\npod/sample-named-port-pod-81 created\n\n<span class=\"token comment\"># 서비스 생성</span>\n$ kubectl apply <span class=\"token parameter variable\">-f</span> sample-named-port-service.yaml\nservice/sample-named-port-service created\n\n<span class=\"token comment\"># 서비스 목적지 엔드포인트 확인</span>\n$ kubectl describe <span class=\"token function\">service</span> sample-named-port-service\nName:              sample-named-port-service\nNamespace:         default\nLabels:            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nAnnotations:       <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nSelector:          <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>sample-app\nType:              ClusterIP\nIP Family Policy:  SingleStack\nIP Families:       IPv4\nIP:                <span class=\"token number\">10.96</span>.197.223\nIPs:               <span class=\"token number\">10.96</span>.197.223\nPort:              http-port  <span class=\"token number\">8080</span>/TCP\nTargetPort:        http/TCP\nEndpoints:         <span class=\"token number\">10.244</span>.3.36:80,10.244.2.9:81\nSession Affinity:  None\nEvents:            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\n\n<span class=\"token comment\"># 파드 IP 주소 확인</span>\n$ kubectl get pods <span class=\"token parameter variable\">-o</span> wide\nNAME                                 READY   STATUS    RESTARTS   AGE    IP            NODE                   NOMINATED NODE   READINESS GATES\nsample-named-port-pod-80             <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          117s   <span class=\"token number\">10.244</span>.3.36   kind-cluster-worker    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nsample-named-port-pod-81             <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          117s   <span class=\"token number\">10.244</span>.2.9    kind-cluster-worker3   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></code></pre></div>\n<h2>6.2.2 클러스터 내부 DNS와 서비스 디스커버리</h2>\n<p>서비스 디스커버리란 특정 조건의 대상이 되는 멤버를 보여주거나 이름에서 엔드포인트를 판별하는 기능이다. 쿠버네티스에서 서비스 디스커버리란 서비스에 속해 있는 파드를 보여주거나 서비스명에서 엔드포인트 정보를 반환하는 것을 말한다. </br></p>\n<p>서비스 디스커버리 방법은 크게 세가지가 있다.</p>\n<ul>\n<li>환경 변수를 사용한 서비스 디스커버리</li>\n<li>DNS A 레코드를 사용한 서비스 디스커버리</li>\n<li>DNS SRV 레코드를 사용한 서비스 디스커버리</li>\n</ul>\n<h3>환경 변수를 사용한 서비스 디스커버리</h3>\n<p>파드 내부에서는 환경 변수에서도 같은 네임 스페이스 서비스를 확인할 수 있다. <code class=\"language-text\">-</code>이 포함된 서비스명은 _로 변경된 후 대문자로 변환된다. <code class=\"language-text\">docker --links ...</code>로 실행했을 때와 같은 형식으로 환경 변수가 저장되기 때문에 도커 자체에서 사용하던 환경에서 마이그레이션할 때도 사용하기 편하다. 그러나 파드가 생성된 후 생성이나 삭제에 따라 변경된 환경 변수가 먼저 기동한 파드 환경에서 자동으로 다시 등록되지 않기 때문에 예기치 못한 장애로 이어질 수 있다. 그런 경우에는 먼저 생성한 파드를 다시 생성하면 된다. </br></p>\n<p><code class=\"language-text\">sepc.enableServiceLinks</code>를 false로 설정하면 환경 변수 추가를 비활성화할 수 있다. 이 파라미터의 기본값은 true로 설정되어 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># pod 확인</span>\n$ kubectl get pods\nNAME                                 READY   STATUS    RESTARTS   AGE\nsample-deployment-65b84c8657-b5795   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          59m\nsample-deployment-65b84c8657-nfhch   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          59m\nsample-deployment-65b84c8657-v244g   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          59m\n\n<span class=\"token comment\"># 환경 변수에 등록된 서비스 정보 확인</span>\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-deployment-65b84c8657-b5795 -- <span class=\"token function\">env</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-i</span> kubernetes\n<span class=\"token assign-left variable\">KUBERNETES_PORT</span><span class=\"token operator\">=</span>tcp://10.96.0.1:443\n<span class=\"token assign-left variable\">KUBERNETES_SERVICE_PORT_HTTPS</span><span class=\"token operator\">=</span><span class=\"token number\">443</span>\n<span class=\"token assign-left variable\">KUBERNETES_SERVICE_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">443</span>\n<span class=\"token assign-left variable\">KUBERNETES_SERVICE_HOST</span><span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.0.1\n<span class=\"token assign-left variable\">KUBERNETES_PORT_443_TCP_ADDR</span><span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.0.1\n<span class=\"token assign-left variable\">KUBERNETES_PORT_443_TCP_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">443</span>\n<span class=\"token assign-left variable\">KUBERNETES_PORT_443_TCP_PROTO</span><span class=\"token operator\">=</span>tcp\n<span class=\"token assign-left variable\">KUBERNETES_PORT_443_TCP</span><span class=\"token operator\">=</span>tcp://10.96.0.1:443</code></pre></div>\n<h3>DNS A 레코드를 사용한 서비스 디스커버리</h3>\n<p>다른 파드에서 서비스로 할당되는 엔드포인트에 접속하려면 당연히 목적지가 필요하지만, 할당된 IP 주소를 사용하는 방법 외에도 자동 등록된 DNS 레코드를 사용할 수 있다. 쿠버네티스에서 IP 주소를 사용하는 방법 외에도 자동 등록되 DNS 레코드를 사용할 수 있다. 쿠버네티스에서 IP 주소를 편하게 관리하려면 기본적으로 자동 할당된 IP 주소에 연결된 DNS명을 사용하는 것이 바람직하다. 할당되는 IP 주소는 서비스를 생성할 때마다 변경되므로 IP 주소를 송신 측 컨테이너 설정 파일 등에서 명시적으로 설정하면 변경될 때마다 설정 파일 등을 변경해야 하기 때문에 컨테이너를 변경 불가능한 상태로 유지할 수 없다.</p>\n<p>아래와 같이 <a href=\"http://sample-culsterip:8080\">http://sample-culsterip:8080</a> 으로 요청했을 때 cluster-ip의 이름이 해석되고 10.96.214.33(엔드포인트)로 요청이 발송되도록 되어 있다. 실제로 등록된 정식 FQDN은 '서비스명.네임스페이스명.svc.cluster.local'로 되어 있다. 이 FQDN에는 서비스가 충돌하지 않도록 네임스페이스 등이 포함되어 있는데, 컨테이너 내부의 /etc/resolve.conf에 다음과 같은 내용 (search로 시작하는 행)이 있기 때문에 <code class=\"language-text\">sample-clusterip.default</code>나 sample-clusterip 만으로 이름을 해석할 수 있다. 이 설정은 기본 네임스페이스라면 <code class=\"language-text\">default.svc.cluster.local</code>이 들어가 있듯이 네임스페이스별로 다르다. 동일한 네임스페이스라면 sample-clusterip로 해석이 가능하지만 다른 네임스페이스라면 sample-clusterip.default와 같이 네임스페이스명을 붙여 이름을 해석해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> http://sample-clusterip:8080\n<span class=\"token assign-left variable\">Host</span><span class=\"token operator\">=</span>sample-clusterip  <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/  <span class=\"token assign-left variable\">From</span><span class=\"token operator\">=</span>sample-deployment-65b84c8657-v244g  <span class=\"token assign-left variable\">ClientIP</span><span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.1.9  <span class=\"token assign-left variable\">XFF</span><span class=\"token operator\">=</span>\n\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> http://sample-clusterip:8080\n<span class=\"token assign-left variable\">Host</span><span class=\"token operator\">=</span>sample-clusterip  <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/  <span class=\"token assign-left variable\">From</span><span class=\"token operator\">=</span>sample-deployment-65b84c8657-b5795  <span class=\"token assign-left variable\">ClientIP</span><span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.1.9  <span class=\"token assign-left variable\">XFF</span><span class=\"token operator\">=</span>\n<span class=\"token punctuation\">..</span>.\n\n<span class=\"token comment\"># sample-clusterip.default.svc.cluster.local의 이름 해석 확인</span>\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">dig</span> sample-clusterip.default.svc.cluster.local\n<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> QUESTION SECTION:\n<span class=\"token punctuation\">;</span>sample-clusterip.default.svc.cluster.local. IN A\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> ANSWER SECTION:\nsample-clusterip.default.svc.cluster.local. <span class=\"token number\">30</span> IN A <span class=\"token number\">10.96</span>.214.33\n\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">dig</span> sample-clusterip.default.svc.cluster.local\n<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> QUESTION SECTION:\n<span class=\"token punctuation\">;</span>sample-clusterip.default.svc.cluster.local. IN A\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> ANSWER SECTION:\nsample-clusterip.default.svc.cluster.local. <span class=\"token number\">30</span> IN A <span class=\"token number\">10.96</span>.214.33\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Query time: <span class=\"token number\">1</span> msec\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> SERVER: <span class=\"token number\">10.96</span>.0.10<span class=\"token comment\">#53(10.96.0.10)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> WHEN: Fri Sep 09 06:47:11 UTC <span class=\"token number\">2022</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> MSG SIZE  rcvd: <span class=\"token number\">141</span>\n\n<span class=\"token comment\"># /etc/resolv.conf 확인</span>\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">cat</span> /etc/resolv.conf\nsearch default.svc.cluster.local svc.cluster.local cluster.local\nnameserver <span class=\"token number\">10.96</span>.0.10\noptions ndots:5\n\n<span class=\"token comment\"># 역질의</span>\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">dig</span> <span class=\"token parameter variable\">-x</span> <span class=\"token number\">10.96</span>.214.33\n<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> QUESTION SECTION:\n<span class=\"token punctuation\">;</span><span class=\"token number\">33.214</span>.96.10.in-addr.arpa.\tIN\tPTR\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> ANSWER SECTION:\n<span class=\"token number\">33.214</span>.96.10.in-addr.arpa. <span class=\"token number\">30</span>\tIN\tPTR\tsample-clusterip.default.svc.cluster.local.\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Query time: <span class=\"token number\">2</span> msec\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> SERVER: <span class=\"token number\">10.96</span>.0.10<span class=\"token comment\">#53(10.96.0.10)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> WHEN: Fri Sep 09 06:55:09 UTC <span class=\"token number\">2022</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> MSG SIZE  rcvd: <span class=\"token number\">147</span></code></pre></div>\n<h3>DNS SRV 레코드를 사용한 서비스 디스커버리</h3>\n<p>정방향과 역방향으로 DNS 레코드가 질의되는 것을 확인하였는데, SRV 레코드를 사용해서 서비스 엔드포인트를 확인할 수도 있다. SRV 레코드는 포트명과 프로토콜을 사용하여 서비스를 제공하는 포트 번호를 포함한 엔드포인트를 DNS로 해석하는 구조다. 레코드 형식은 다음과 같다. 서비스의 포트명과 프로토콜에는 접두사 _가 포함되므로 주의하자.</p>\n<p><code class=\"language-text\">_서비스포트명_프로토콜.서비스명.네임스페이스명.svc.cluster.local</code></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>clusterip\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app</code></pre></div>\n<p>실제로 SVR을 확인해보면, 다음과 같이 목적지 호스트명 sample-clusterip.default.svc.cluster.local과 포트 번호 8080을 해석할 수 있다. SRV 레코드를 해석할 수 있는 소프트웨어의 경우 이와 같은 서비스를 제공하는 포트 번호를 포함한 엔드포인트까지 DNS로 해석할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># SRV 레코드가 다른 파드에서 해석이 가능한지 확인</span>\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">dig</span> _http-port._tcp.sample-clusterip.default.svc.cluster.local SRV\n<span class=\"token punctuation\">..</span>.\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> OPT PSEUDOSECTION:\n<span class=\"token punctuation\">;</span> EDNS: version: <span class=\"token number\">0</span>, flags:<span class=\"token punctuation\">;</span> udp: <span class=\"token number\">4096</span>\n<span class=\"token punctuation\">;</span> COOKIE: 1df44dd154a59433 <span class=\"token punctuation\">(</span>echoed<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> QUESTION SECTION:\n<span class=\"token punctuation\">;</span>_http-port._tcp.sample-clusterip.default.svc.cluster.local. IN SRV\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> ANSWER SECTION:\n_http-port._tcp.sample-clusterip.default.svc.cluster.local. <span class=\"token number\">30</span> IN SRV <span class=\"token number\">0</span> <span class=\"token number\">100</span> <span class=\"token number\">8080</span> sample-clusterip.default.svc.cluster.local.</code></pre></div>\n<h1>6.3 ClusterIP 서비스</h1>\n<p>ClusterIP 서비스는 쿠버네티스의 가장 기본이 되는 <code class=\"language-text\">type: ClusterIP</code> 서비스다. 이 서비스를 생성하면 클러스터 내부에서만 통신 가능한 Internal Network에 생성되는 가상 IP가 할당된다. 따라서 ClusterIP라고 불린다. ClusterIP는 각 노드상에서 실행 중인 시스템 구성 요소 kube-proxy가 파드로 전송을 실시한다. ClusterIP는 쿠버네티스 클러스터 외부에서 트래픽을 수신할 필요가 없는 환경에서 클러스터 내부 로드 밸런서로 사용된다. 기본적으로는 쿠버네티스 API에 접속하기 위한 Kubernetes 서비스가 생성되어 있고, ClusterIP가 발급되어 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 쿠버네티스 API에 접속할 수 있도록 쿠버네티스 서비스가 생성됨</span>\n$ kubectl get services\nNAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>    AGE\nkubernetes         ClusterIP   <span class=\"token number\">10.96</span>.0.1      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">443</span>/TCP    41d\nsample-clusterip   ClusterIP   <span class=\"token number\">10.96</span>.214.33   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">8080</span>/TCP   80m</code></pre></div>\n<div align=\"center\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 449px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/e5fcc776e9153cd5e5d6bd5d7896ca54/053a9/clusterip.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 72.78481012658227%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC+UlEQVR42nWTaU8bVxSG/ftbVcq3SG3TigZXoQ1SDDRKkYVxwYAzthnv4wXvC15nsWexDXl67oRWaUs/vDpXZ3nPeiPJwoRUacrlv5Aqz0jqI2LnJX67MIidFYhnuqKfP+M75Tw/YTBZEUnXTDINi0z9n8g2bK7E+eDkmjdHlxwcp0je9sndOWJ/inlCVqB4xguPSOBvUNgG/8Vus+Vh98BG3o+Pn9htd8/6BX4QYhNsFWGA7wXYjvcsLHvNfGFjOa5gLTr3CWJfeTgrP0y43QS4a6mQT4+YToDRNWkMTOp9k1pvSX1gkav2+ZDQOD5NcfGxTHNoi30Z+lS7ixDl1ozR1CYIdniuEJbrfYpGl6wxong3p9Keh44qsNqeiW6KZgzJ1sfoYtNbc5nhlGarz202R0bL0ukOpHpp2/WJdAZTWr0x+cY9emMqciZyRrrQp/b7H2TLHUqNcVhJWSXrLEJZMHoUKk1KRpt2b8LScgk8/3PLjhtQk4qa0nKxM0cbWujLLZpeJfbD91ycvKcwtinIFrWeavVzJ4pYJVqY63BhYctqk2rgqs2GkGbE6XQUcN5csX+W58XPH3h5mOQo0yHZ9YkPHCqSVM2xLrNW83bWAY9yDZ5ayoMw244fEjbFKSMZ9/QxL09KvPglzVf7cb6OJvgmmuS7eJ3D6gyjpxa3CGFI3N+E7heEyqCyGR0TXYZeak3JGDW06p0cryyl0UerdGSmdYzWGKNtSYxAVbj6X0JTHDr0F23yiVPie69o5W9ojnvUBm2GsxbXsQMS+z/SbZeo3/dklrOwwofd7suWPdnePKyuPPiIMbnl6OwdPx2+Jt/NUp1co/cSVO513p6+JRqLUhrmMKY3FJsjIZSftPtrKULorP1ww+2RjdbQib7P8+2bFPtHOfaOilyW09zUbnh9XODVr1fsvdOInpS5qqYlbsbK3YQVumuXiGL15CDdEB4r+U6WKV/NsjGXIk0Lx3ZZqW8o79Am0lyKXq5DxXhyf75Acf0JhlVAEu4GITAAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"clusterip\" title=\"\" src=\"/static/e5fcc776e9153cd5e5d6bd5d7896ca54/053a9/clusterip.png\" srcset=\"/static/e5fcc776e9153cd5e5d6bd5d7896ca54/c26ae/clusterip.png 158w,\n/static/e5fcc776e9153cd5e5d6bd5d7896ca54/6bdcf/clusterip.png 315w,\n/static/e5fcc776e9153cd5e5d6bd5d7896ca54/053a9/clusterip.png 449w\" sizes=\"(max-width: 449px) 100vw, 449px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</div>\n<h2>6.3.1 ClusterIP 생성</h2>\n<p>매니페스트는 기존 사용했던 sample-clusterip 매니페스트를 사용한다. <code class=\"language-text\">type: ClusterIP</code>를 지정하면 ClusterIP 서비스를 생성할 수 있다. <code class=\"language-text\">spec.ports[].port</code>에는 ClusterIP에서 수신할 포트 번호를 지정하고, <code class=\"language-text\">spec.ports[].targetPort</code>는 목적지 컨테이너 포트 번호를 지정한다.</p>\n<h2>6.3.2 ClusterIP 가상 IP 정적 지정</h2>\n<p>애플리케이션에서 데이터베이스 서버를 지정하는 경우 기본적으로 쿠버네티스 서비스에 등록된 클러스터 내부 DNS 레코드를 사용하여 호스트를 지정하는 것이 바람직하다. 그러나, IP주소로 지정해야 하는 경우 ClusterIP를 정적으로 지정할 수도 있다.</p>\n<p>ClusterIP를 자동 할당이 아닌 수동으로 설정할 경우 <code class=\"language-text\">spec.clusterIP</code>를 지정한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>clusterip<span class=\"token punctuation\">-</span>vip\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">clusterIP</span><span class=\"token punctuation\">:</span> 10.51.246.81\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app</code></pre></div>\n<p>서비스가 이미 생성된 후에는 ClusterIP를 변경할 수 없다. 쿠버네티스에서는 <code class=\"language-text\">kubectl apply</code>를 사용하여 설정값을 변경할 수 있다고 설명하지만, 쿠버네티스 특성상 ClusterIP 값 등과 같은 일부 필드는 변경할 수 없게 설정되어 있다.</p>\n<h1>6.4 ExternalIP 서비스</h1>\n<p>ExternalIP는 특정 쿠버네티스 노드 IP주소:포트에서 수신한 트래픽을 컨테이너로 전송하는 형태로 외부와 통신할 수 있도록 하는 서비스다. 그리고 특별한 이유가 없는 경우에는 ExternalIP 서비스 대신 나중에 설명할 NodePort 서비스를 사용하는 것이 더 좋다.</p>\n<h2>6.4.1 ExternalIP 서비스 생성</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>externalip\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">externalIPs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> 172.18.0.2\n    <span class=\"token punctuation\">-</span> 172.18.0.3\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app</code></pre></div>\n<p>ExternalIP는 ClusterIP의 한 종류이기 때문에 type은 역시 ClusterIP로 지정한다. <code class=\"language-text\">spec.externalIPs</code>에는 쿠버네티스 노드 IP(10.178.0.61 등)를, <code class=\"language-text\">spec.ports[].port</code>에는 쿠버네티스 노드의 IP와 ClusterIP에서 수신할 포트 번호를, <code class=\"language-text\">spec.ports[].targetPorts</code>에는 목적지 컨테이너 포트를 지정한다. 또한, ExternalIP에서 사용하는 IP는 모든 쿠버네티스 노드의 IP를 넣을 필요가 없다.</br></p>\n<p>ExternalIP에 사용 가능한 IP주소는 노드 정보에서 확인할 수 있다. 생성한 ExternalIP 서비스를 확인해보면, 컨테이너 내부에서의 통신은 ClusterIP를 사용하기 위해 ClusterIP도 자동으로 확보된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 쿠버네티스 노드 목록과 주소 출력</span>\n$ kubectl get nodes <span class=\"token parameter variable\">-o</span> custom-columns<span class=\"token operator\">=</span><span class=\"token string\">\"NAME:{metadata.name},IP:{status.addresses[].address}\"</span>\nNAME                         IP\nkind-cluster-control-plane   <span class=\"token number\">172.18</span>.0.5\nkind-cluster-worker          <span class=\"token number\">172.18</span>.0.4\nkind-cluster-worker2         <span class=\"token number\">172.18</span>.0.3\nkind-cluster-worker3         <span class=\"token number\">172.18</span>.0.2\n\n<span class=\"token comment\"># ExternalIP 서비스 확인</span>\n$ kubectl get services\nNAME                TYPE        CLUSTER-IP     EXTERNAL-IP             PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>    AGE\nkubernetes          ClusterIP   <span class=\"token number\">10.96</span>.0.1      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                  <span class=\"token number\">443</span>/TCP    41d\nsample-clusterip    ClusterIP   <span class=\"token number\">10.96</span>.214.33   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                  <span class=\"token number\">8080</span>/TCP   96m\nsample-externalip   ClusterIP   <span class=\"token number\">10.96</span>.170.55   <span class=\"token number\">172.18</span>.0.2,172.18.0.3   <span class=\"token number\">8080</span>/TCP   21s\n\n<span class=\"token comment\"># 외부에서 ExternalIP로 통신</span>\n$ <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> http://172.18.0.2:8080</code></pre></div>\n<h2>출처</h2>\n<p><a href=\"https://dev-youngjun.tistory.com/20\">https://dev-youngjun.tistory.com/20</a></p>","frontmatter":{"title":"[쿠버네티스 완벽 가이드] 12. 서비스 API 카테고리 (1) - 서비스 API 카테고리 개요 및 쿠버네티스 클러스터 네트워크와 서비스","date":"September 09, 2022","description":null}},"previous":{"fields":{"slug":"/server/loadbalancer/"},"frontmatter":{"title":"로드밸런서의 개념과 종류"}},"next":{"fields":{"slug":"/kubernetes/kubernetes_6_2/"},"frontmatter":{"title":"[쿠버네티스 완벽 가이드] 13. 서비스 API 카테고리 (2) - NodePort, LoadBalancer, 그 외 서비스"}}},"pageContext":{"id":"136e2b60-609d-5eea-8b35-c7dc6cee613b","previousPostId":"1bc87a81-542c-500c-8f2c-640da0206c0a","nextPostId":"959e2e53-26c3-52e7-be44-df4578740b0f"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}