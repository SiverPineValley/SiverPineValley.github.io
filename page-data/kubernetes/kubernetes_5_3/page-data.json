{"componentChunkName":"component---src-templates-blog-post-js","path":"/kubernetes/kubernetes_5_3/","result":{"data":{"site":{"siteMetadata":{"title":"Devlog"}},"markdownRemark":{"id":"59e8bd7f-75e7-51fa-8f94-ab7d2b3289ab","excerpt":"5.4 디플로이먼트 디플로이먼트(Deployment…","html":"<h1>5.4 디플로이먼트</h1>\n<p>디플로이먼트(Deployment)는 여러 레플리카셋을 관리하여 롤링 업데이트나 롤백 등을 구현하는 리소스이다. 디플로이먼트가 레플리카셋을 관리하고 레플리카셋이 파드를 관리하는 관계이다. 다음과 같이 동작한다.</p>\n<ol>\n<li>신규 레플리카셋을 생성</li>\n<li>신규 레플리카셋의 레플리카 수를 단계적으로 늘림</li>\n<li>신규 레플리카셋의 레플리카 수를 단계적으로 줄임</li>\n<li>(2,3)을 반복</li>\n<li>이전 레플리카셋은 레플리카 수를 0으로 유지</li>\n</ol>\n<p>디플로이먼트를 사용하면 신규 레플리카셋에 컨테이너가 기동되었는지와 헬스 체크는 통과했는지를 확인하면서 전환 작업이 진행되며, 레플리카셋의 이행 과정에서 파드 수에 대한 상세 지정도 가능하다. 이는 쿠버네티스에서 가장 권장하는 컨테이너 기동 방법으로 알려져 있다. 지금까지 파드나 레플리카셋의 사용 방법도 설명했는데, 가령 하나의 파드를 기동만 한다 하더라도 디플로이먼트 사용을 권장한다. 파드만으로 배포한 경우 파드에 장애가 생기면 파드가 다시 생성되지 않으며, 레플리카셋의 경우에도 롤링 업데이트 등의 기능을 사용할 수 없다.</p>\n<h2>5.4.1 디플로이먼트 생성</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>deployment\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>container\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span><span class=\"token number\">1.12</span>\n          <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<p>매니페스트로 디플로이먼트를 생성한다. 이번에는 <code class=\"language-text\">--record</code> 옵션을 사용하여 어떤 명령어를 실행하고 업데이트했는지 이력을 지정해 둔다. 이력을 작성해 놓으면, 나중에 설명하는 <code class=\"language-text\">kubectl rollout</code>에서 롤백 등을 실시할 때 참고 정보로 사용할 수 있다. 실제 서비스 환경에서 rollout 기능을 사용할 일은 많지 않아 <code class=\"language-text\">--record</code> 역시 많이 사용되진 않는다. 아래 소스에서 nginx 이미지 버전을 1.12 -> 1.17로 업데이트 하였는데, 덥데이트 후 레플리카셋이 새로 생성되고 거기에 연결되는 형태로 파드도 다시 생성된다. 이때 내부적으로 롤링 업데이트가 되어 실제 서비스에는 영향이 없다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 업데이트 이력을 저장하는 옵션을 사용하여 디플로이먼트 기동</span>\n$ kubectl apply <span class=\"token parameter variable\">-f</span> sample-deployment.yaml <span class=\"token parameter variable\">--record</span>\nFlag <span class=\"token parameter variable\">--record</span> has been deprecated, <span class=\"token parameter variable\">--record</span> will be removed <span class=\"token keyword\">in</span> the future\ndeployment.apps/sample-deployment created\n\n$ kubectl get deployments\nNAME                READY   UP-TO-DATE   AVAILABLE   AGE\nsample-deployment   <span class=\"token number\">3</span>/3     <span class=\"token number\">3</span>            <span class=\"token number\">3</span>           75s\n\n$ kubectl get replicasets <span class=\"token parameter variable\">-o</span> yaml <span class=\"token operator\">|</span> <span class=\"token function\">head</span>\napiVersion: v1\nitems:\n- apiVersion: apps/v1\n  kind: ReplicaSet\n  metadata:\n    annotations:\n      deployment.kubernetes.io/desired-replicas: <span class=\"token string\">\"3\"</span>\n      deployment.kubernetes.io/max-replicas: <span class=\"token string\">\"4\"</span>\n      deployment.kubernetes.io/revision: <span class=\"token string\">\"1\"</span>\n      kubernetes.io/change-cause: kubectl apply <span class=\"token parameter variable\">--filename</span><span class=\"token operator\">=</span>sample-deployment.yaml\n\n<span class=\"token comment\"># 컨테이너 이미지 업데이트</span>\n$ kubectl <span class=\"token builtin class-name\">set</span> image deployment sample-deployment nginx-container<span class=\"token operator\">=</span>nginx:1.17 <span class=\"token parameter variable\">--record</span>\n\n<span class=\"token comment\"># 디플로이먼트 업데이트 상태 확인</span>\n$ kubectl rollout status deployment sample-deployment\ndeployment <span class=\"token string\">\"sample-deployment\"</span> successfully rolled out</code></pre></div>\n<h2>5.4.2 디플로이먼트 업데이트 조건</h2>\n<p>디플로이먼트에는 변경이 발생되면 위의 예제와 같이 레플리카셋이 다시 생성된다. 이 '변경'에는 레플리카 수의 변경 등은 포함되어 있지 않으며, '생성된 파드 내용의 변경'이 필요하다. 매니페스트를 쿠버네티스에 등록하게 되면, <code class=\"language-text\">spec.template</code> 아래의 해시값(파드 템플릿 해시)를 계신하고 이 값을 사용한 레이블로 관리한다. 다시 수작업으로 이미지 등을 이전 버전으로 재변경하여 해시값이 동일해진 경우에는 레플리카셋을 신규로 생성하지 않고 기존 레플리카셋을 사용한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ kubectl get replicasets\nNAME                           DESIRED   CURRENT   READY   AGE\nsample-deployment-567547fc8    <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       31m <span class=\"token comment\"># 1.17 버전의 레플리카셋</span>\nsample-deployment-847b7dfb49   <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       6d19h <span class=\"token comment\"># 1.12 버전의 레플리카셋</span></code></pre></div>\n<h2>5.4.3 변경 롤백</h2>\n<p>디플로이먼트에는 롤백 기능이 있다. 롤백 기능의 실체는 현재 사용 중인 레플리카셋의 전환과 같은 것이다. 디플로이먼트가 기존에 생성한 레플리카셋은 레플리카 수가 0인 상태로 남아 있기 때문에 레플리카 수를 변경시켜 다시 사용할 수 있는 상태가 된다.</p>\n<p>변경 이력을 확인할 때는 <code class=\"language-text\">kubectl rollout history</code> 명령어를 사용한다. <code class=\"language-text\">CHANGE-CAUSE</code> 부분에 이력이 기록되는데, 처음 디플로이먼트를 생성할 때 <code class=\"language-text\">--record</code> 옵션을 사용하여 이력 내용이 있을 때만 이력이 남는다. 해당 버전의 수정 상세 정보를 가져오려면 <code class=\"language-text\">--revision</code> 옵션을 사용한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ kubectl rollout <span class=\"token function\">history</span> deployment sample-deployment <span class=\"token parameter variable\">--revision</span> <span class=\"token number\">1</span>\ndeployment.apps/sample-deployment with revision <span class=\"token comment\">#1</span>\nPod Template:\n  Labels:\t<span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>sample-app\n\tpod-template-hash<span class=\"token operator\">=</span>847b7dfb49\n  Annotations:\tkubernetes.io/change-cause: kubectl apply <span class=\"token parameter variable\">--filename</span><span class=\"token operator\">=</span>sample-deployment.yaml <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true\n  Containers:\n   nginx-container:\n    Image:\tnginx:1.12\n    Port:\t<span class=\"token number\">80</span>/TCP\n    Host Port:\t<span class=\"token number\">0</span>/TCP\n    Environment:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\n    Mounts:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\n  Volumes:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\n\n$ kubectl rollout <span class=\"token function\">history</span> deployment sample-deployent <span class=\"token parameter variable\">--revision</span> <span class=\"token number\">2</span>\ndeployment.apps/sample-deployment with revision <span class=\"token comment\">#2</span>\nPod Template:\n  Labels:\t<span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>sample-app\n\tpod-template-hash<span class=\"token operator\">=</span>567547fc8\n  Annotations:\tkubernetes.io/change-cause: kubectl <span class=\"token builtin class-name\">set</span> image deployment sample-deployment nginx-container<span class=\"token operator\">=</span>nginx:1.17 <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true\n  Containers:\n   nginx-container:\n    Image:\tnginx:1.17\n    Port:\t<span class=\"token number\">80</span>/TCP\n    Host Port:\t<span class=\"token number\">0</span>/TCP\n    Environment:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\n    Mounts:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\n  Volumes:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></code></pre></div>\n<p>롤백하려면 <code class=\"language-text\">kubectl rollout undo</code> 명령어를 사용한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 버전 번호를 지정하여 롤백</span>\n$ kubectl rollout undo deployment sample-deployment --to-revision <span class=\"token number\">1</span>\n\n<span class=\"token comment\"># 바로 이전 버전으로 롤백 (--to-revision이 0으로 지정됨)</span>\n$ kubectl rollout undo deployment sample-deployment\n\n<span class=\"token comment\"># 롤백한 이후 이전 레플리카셋이 다시 기동됨</span>\n$ kubectl get replicasets\nNAME                           DESIRED   CURRENT   READY   AGE\nsample-deployment-567547fc8    <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       42m\nsample-deployment-847b7dfb49   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       6d20h</code></pre></div>\n<h2>5.4.4 디플로이먼트 변경 일시 중지</h2>\n<p>일반적으로는 디플로이먼트 변경을 하면 바로 적용되나, 안전을 위해 업데이트를 잠시 멈추도록 할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 업데이트 일시 중지</span>\n$ kubectl rollout pause deployment sample-deployment\ndeployment.apps/sample-deployment paused\n\n<span class=\"token comment\"># pause 상태에서 컨테이너 이미지 업데이트</span>\n$ kubectl <span class=\"token builtin class-name\">set</span> image deployment sample-deployment nginx-container<span class=\"token operator\">=</span>nginx:1.17\ndeployment.apps/sample-deployment image updated\n\n<span class=\"token comment\"># 업데이트는 대기 상태</span>\n$ kubectl rollout status deployment sample-deployment\nWaiting <span class=\"token keyword\">for</span> deployment <span class=\"token string\">\"sample-deployment\"</span> rollout to finish: <span class=\"token number\">0</span> out of <span class=\"token number\">3</span> new replicas have been updated<span class=\"token punctuation\">..</span>.\n\n<span class=\"token comment\"># 업데이트 재개</span>\n$ kubectl rollout resume deployment sample-deployment\ndeployment.apps/sample-deployment resumed\n\n<span class=\"token comment\"># 업데이트 상태 확인</span>\n$ kubectl rollout status deployment sample-deployment\ndeployment <span class=\"token string\">\"sample-deployment\"</span> successfully rolled out</code></pre></div>\n<h2>5.4.5 디플로이먼트 업데이트 전략</h2>\n<p>위 예제에서는 디플로이먼트를 업데이트하면 <code class=\"language-text\">RollingUpdate</code> 가 진행되었다. 이 외에도 <code class=\"language-text\">Recreate</code> 전략도 있다.</p>\n<h3>Recreate</h3>\n<p><code class=\"language-text\">Recreate</code>는 모든 파드를 한 번 삭제하고 다시 파드를 생성하기 때문에 다운타임이 발생하지만, 추가 리소스를 사용하지 않고 전환이 빠른 것이 장점이다. 기존 레플리카셋의 레플리카 수를 0으로 하고 리소스를 반환한다. 이후 신규 레플리카셋을 생성하고 레플리카 수를 늘린다. 그래서 클러스터 전체에 현재 동작하고 있는 레플리카 수만큼만 리소스가 있다 하더라도 업데이트할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>deployment<span class=\"token punctuation\">-</span>recreate\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Recreate\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>container\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span><span class=\"token number\">1.16</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 컨테이너 이미지 업데이트</span>\n$ kubectl <span class=\"token builtin class-name\">set</span> image deployment sample-deployment-recreate nginx-container<span class=\"token operator\">=</span>nginx:1.17\ndeployment.apps/sample-deployment-recreate image updated\n\n<span class=\"token comment\"># 레플리카셋 목록 표시 (리소스 상태 변화가 있으면 계속 출력)</span>\n$ kubectl get replicasets <span class=\"token parameter variable\">--watch</span>\nNAME                                    DESIRED   CURRENT   READY   AGE\nsample-deployment-567547fc8             <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       51m\nsample-deployment-847b7dfb49            <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       6d20h\nsample-deployment-recreate-5f85cc775b   <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       20s\nsample-deployment-recreate-7b8dbc9899   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">0</span>       0s\nsample-deployment-recreate-7b8dbc9899   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">1</span>       0s\nsample-deployment-recreate-7b8dbc9899   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       0s</code></pre></div>\n<h3>RollingUpdate</h3>\n<p><code class=\"language-text\">Recrate</code>는 위에서 설명한대로 기존 자원을 반환하기 때문에, 추가 리소스를 사용하지 않고 빠른 업데이트가 가능하다. <code class=\"language-text\">RollingUpdate</code>는 업데이트 중에 동시에 정지 가능한 최대 파드 수(<code class=\"language-text\">maxUnavailable</code>)와 업데이트 중에 동시에 생성할 수 있는 최대 파드 수(<code class=\"language-text\">maxSurge</code>)를 설정할 수 있다. 이 설정을 사용하면 추가 리소스를 사용하지 않도록 하거나 많은 리소스를 소비하지 않고 빠르게 전환하는 등 업데이트를 하면서 동작을 제어할 수 있다. 두 값 모두 0으로 설정할 수는 없다. 아래 매피페스트와 같이 <code class=\"language-text\">maxUnavailable=0</code>, <code class=\"language-text\">maxSurge=1</code> 설정으로 하면 <code class=\"language-text\">maxSurge</code> 수만틈 추가 레플리카 수를 늘려 파드를 이동시킨다. <code class=\"language-text\">maxUnavailable</code>과 <code class=\"language-text\">maxSurge</code>는 백분율로도 지정할 수 있다. 지정하지 않을 경우 기본 값은 모두 25%이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>deployment<span class=\"token punctuation\">-</span>rollingupdate\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> RollingUpdate\n    <span class=\"token key atrule\">rollingUpdate</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">maxUnavailable</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n      <span class=\"token key atrule\">maxSurge</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>container\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span><span class=\"token number\">1.16</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 컨테이너 이미지 업데이트</span>\n$ kubectl <span class=\"token builtin class-name\">set</span> image deployment sample-deployment-rollingupdate nginx-container<span class=\"token operator\">=</span>nginx:1.17\ndeployment.apps/sample-deployment-rollingupdate image updated\n\n<span class=\"token comment\"># 레플리카셋 목록 표시(리소스 상태 변화가 있으면 계속 출력)</span>\n$ kubectl get replicasets <span class=\"token parameter variable\">--watch</span>\nNAME                                         DESIRED   CURRENT   READY   AGE\nsample-deployment-567547fc8                  <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       57m\nsample-deployment-847b7dfb49                 <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       6d20h\nsample-deployment-rollingupdate-5f85cc775b   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       66s\nsample-deployment-rollingupdate-7b8dbc9899   <span class=\"token number\">1</span>         <span class=\"token number\">1</span>         <span class=\"token number\">0</span>       1s\nsample-deployment-rollingupdate-7b8dbc9899   <span class=\"token number\">1</span>         <span class=\"token number\">1</span>         <span class=\"token number\">1</span>       1s\nsample-deployment-rollingupdate-5f85cc775b   <span class=\"token number\">2</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       66s\nsample-deployment-rollingupdate-5f85cc775b   <span class=\"token number\">2</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       66s\nsample-deployment-rollingupdate-7b8dbc9899   <span class=\"token number\">2</span>         <span class=\"token number\">1</span>         <span class=\"token number\">1</span>       1s\nsample-deployment-rollingupdate-5f85cc775b   <span class=\"token number\">2</span>         <span class=\"token number\">2</span>         <span class=\"token number\">2</span>       66s\nsample-deployment-rollingupdate-7b8dbc9899   <span class=\"token number\">2</span>         <span class=\"token number\">1</span>         <span class=\"token number\">1</span>       1s\nsample-deployment-rollingupdate-7b8dbc9899   <span class=\"token number\">2</span>         <span class=\"token number\">2</span>         <span class=\"token number\">1</span>       1s\nsample-deployment-rollingupdate-7b8dbc9899   <span class=\"token number\">2</span>         <span class=\"token number\">2</span>         <span class=\"token number\">2</span>       2s\nsample-deployment-rollingupdate-5f85cc775b   <span class=\"token number\">1</span>         <span class=\"token number\">2</span>         <span class=\"token number\">2</span>       67s\nsample-deployment-rollingupdate-5f85cc775b   <span class=\"token number\">1</span>         <span class=\"token number\">2</span>         <span class=\"token number\">2</span>       67s\nsample-deployment-rollingupdate-7b8dbc9899   <span class=\"token number\">3</span>         <span class=\"token number\">2</span>         <span class=\"token number\">2</span>       2s\nsample-deployment-rollingupdate-5f85cc775b   <span class=\"token number\">1</span>         <span class=\"token number\">1</span>         <span class=\"token number\">1</span>       67s\nsample-deployment-rollingupdate-7b8dbc9899   <span class=\"token number\">3</span>         <span class=\"token number\">2</span>         <span class=\"token number\">2</span>       2s\nsample-deployment-rollingupdate-7b8dbc9899   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">2</span>       2s\nsample-deployment-rollingupdate-7b8dbc9899   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       3s\nsample-deployment-rollingupdate-5f85cc775b   <span class=\"token number\">0</span>         <span class=\"token number\">1</span>         <span class=\"token number\">1</span>       68s\nsample-deployment-rollingupdate-5f85cc775b   <span class=\"token number\">0</span>         <span class=\"token number\">1</span>         <span class=\"token number\">1</span>       68s\nsample-deployment-rollingupdate-5f85cc775b   <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       68s</code></pre></div>\n<h2>5.4.6 상세 업데이트 파라미터</h2>\n<p><code class=\"language-text\">Recreate</code>나 <code class=\"language-text\">RollingUpdate</code>를 사용할 때는 다른 파라미터를 사용하여 설정할 수도 있다.</p>\n<ul>\n<li>minReadySeconds(최소 대기 시간(초)): 파드가 Ready 상태가 된 다음부터 디플로이먼트 리소스에서 파드 기동이 완료되었다고 판단(다음 파드의 교체가 가능하다고 판단)하기까지의 최소 시간(초)</li>\n<li>revisionHistoryLimit(수정 버전 기록 제한): 디플로이먼트가 유지할 레플리카셋 수, 롤백이 가능한 이력 수</li>\n<li>progressDeadlineSeconds(진행 기한 시간(초)): <code class=\"language-text\">Recreate</code>/<code class=\"language-text\">RollingUpdate</code> 처리 타임아웃 시간, 타임아웃 시간이 경과하면 자동으로 롤백</li>\n</ul>\n<p>위의 내용은 모두 디플로이먼트의 <code class=\"language-text\">spec</code> 아래에 설정할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>deployment<span class=\"token punctuation\">-</span>params\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">minReadySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n  <span class=\"token key atrule\">revisionHistoryLimit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">progressDeadlineSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3600</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>container\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span><span class=\"token number\">1.16</span></code></pre></div>\n<h2>5.4.7 디플로이먼트 스케일링</h2>\n<p>디플로이먼트가 관리하면 레플리카셋의 레플리카 수는 레플리카셋과 같은 방법으로 <code class=\"language-text\">kubectl apply -f</code> 또는 <code class=\"language-text\">kubectl scale</code>을 사용하여 스케일 할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 레플리카 수를 3에서 4로 변경한 매니페스트를 apply</span>\n$ <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|replicas: 3|replicas: 4|'</span> sample-deployment.yaml\n$ kubectl apply <span class=\"token parameter variable\">-f</span> sample-deployment.yaml\ndeployment.apps/sample-deployment configured\n\n<span class=\"token comment\"># kubectl scale 명령어를 사용한 스케일링</span>\n$ kubectl scale deployment sample-deployment <span class=\"token parameter variable\">--replicas</span><span class=\"token operator\">=</span><span class=\"token number\">5</span>\ndeployment.apps/sample-deployment scaled\n\n$ kubectl get pods <span class=\"token parameter variable\">-L</span> app\nNAME                                 READY   STATUS    RESTARTS      AGE   APP\nsample-deployment-5988795749-5bw7c   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             56s   sample-app\nsample-deployment-5988795749-5rvp4   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             56s   sample-app\nsample-deployment-5988795749-kktn8   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             57s   sample-app\nsample-deployment-5988795749-pc2tr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             36s   sample-app\nsample-deployment-5988795749-xsj5h   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             57s   sample-app</code></pre></div>","frontmatter":{"title":"[쿠버네티스 완벽 가이드] 09. 워크로드 API 카테고리 (3) - 디플로이먼트","date":"August 28, 2022","description":null}},"previous":{"fields":{"slug":"/kubernetes/kubernetes_5_2/"},"frontmatter":{"title":"[쿠버네티스 완벽 가이드] 08. 워크로드 API 카테고리 (2) - 레플리카셋/레플리케이션 컨트롤러"}},"next":{"fields":{"slug":"/linux/sed/"},"frontmatter":{"title":"[Linux] sed 명령어"}}},"pageContext":{"id":"59e8bd7f-75e7-51fa-8f94-ab7d2b3289ab","previousPostId":"863c8140-4bbd-5d28-b250-91c73e7aacea","nextPostId":"e080223f-e695-5ef7-8ee4-8fd1d1dc612b"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}