{"componentChunkName":"component---src-templates-blog-post-js","path":"/kubernetes/kubernetes_6_2/","result":{"data":{"site":{"siteMetadata":{"title":"Devlog"}},"markdownRemark":{"id":"959e2e53-26c3-52e7-be44-df4578740b0f","excerpt":"6.5 NodePort NodePort 서비스는 ExternalIP와 비슷하다. 앞서 설명한 ExternalIP는 지정한 쿠버네티스 노드의 IP 주소:포트에서 수신한 트래픽을 컨테이너로 전송하는 형태로 외부와 통신할 수 있었다. 반면 NodePort는 모든 쿠버네티스 노드의 IP…","html":"<h1>6.5 NodePort</h1>\n<p>NodePort 서비스는 ExternalIP와 비슷하다. 앞서 설명한 ExternalIP는 지정한 쿠버네티스 노드의 IP 주소:포트에서 수신한 트래픽을 컨테이너로 전송하는 형태로 외부와 통신할 수 있었다. 반면 NodePort는 모든 쿠버네티스 노드의 IP 주소:포트에서 수신한 트래픽을 컨테이너에 전송하는 형태로 외부와 통신할 수 있다. ExternalIP와 유사하지만, Listen할 때 0.0.0.0:포트를 사용하여 모든 IP주소로 바인드하는 형태이다. 여기서 주의할 점은 외부라는 것이 클러스터 외부를 뜻하는 것이 아니라, 파드 네트워크(내부 네트워크) 외부의 클러스터 네트워크를 의미한다. </br>\n생성한 NodePort를 확인해보면 컨테이너 내부에서의 통신에 ClusterIP를 사용하기 위해 ClusterIP도 자동으로 확보된다. 컨테이너 내부에서 확인해보면 클러스터 내부 DNS에서 반환하는 서비스 디스커버리 IP 주소는 ClusterIP가 된다.</p>\n<div align=\"center\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 446px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/df126666647f8770d2c581b3773e814a/6244b/nodeport.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 80.37974683544303%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADBUlEQVR42nWT63PaRhTF+fv7qTPOTD518pgkjdPYTmqnxQkNJmAHAhghHoYIkBAKL1kIsIQQD/+6ErQmbqrRmd3ZPffsvbv3RKqaTUIecl42SYUYbmHySe5z8umK3+MVDmMS0c+NLee/CDRq+phIs+uQV8YUmvcx4VKxOf7rkl/fJtg/SXISLyK1pv/u7yInNNS+Q8Sf+/jzOQvfZ/kD3K5vxd6C9Wol5utwbbHF7nyj4xOZOS6+N8eeuFi2w0jA+gdjh4E5ptu36A9HmNY0XBtteaPx3ejNPGauSySYLBdL1O6YatsS9zDaQMyVzpiLyzqxlMTx+wtyJRXFGId7dcGpb7lKx8bzfOaedyeode8RBUk2bCTdIlFUSJaaSB0rXKuLvbq+4dbaO4Kz/xFsiCzO8nUOq0MOsm1+evoHe6/jvC10eVPpcZat0uxOQ/5uht53gj0hqNt8FWKVlmijYpODdJMX70s8eZfjF4HH0SLHeZ2MrFJqDEJuENMw7me4XIV3mJNb5EVpn/NVUpkSUrmFVFVpfLO56ozI1lqcVxqkS3XOcxWKVzqFqhaW73mLO8H1ak1NG5IvlDHabQy9I2Cga22yeZlSayCCplxIceLSU9HIL6mrWbSGhlSscHnVwfdX3wsafZsvOYmyLHMaPSX2IUa1XCGTyaP3J/Qsj3Q2Qzof4zR+SOxjlIpcplCQUbS+uLYVnrsjGDx5MpHk+esoP+89Yu/hMw7enJJMplgvlwRf7kuOZ/tRHj0+4sHDFzx/9Y4PsTOcyTTUmLmzjeBK3GHgBtO8Rq03Sfx2xMdXR2i1rwyG1ziOhzvzGZqiN8tV4vsHpI7/pCW4g4EZxq/EoeErB6rBK2/sdQvid25cesIZ7mwh2skWZVYolBWM4RTH9VGNa1p6n8l0xrV9Q9sYMrRuRIbbkncRLM6FFRfCl44zE0GBvW5CjIXFggQC+ymKgnRZIJPO0FY1YU07PCASZPdD+JtxJbAWJa23ZQWjaU1QmgYV0UYN9RvmyKEnPO/PF/wNf5SPpNnVhtwAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"nodeport\" title=\"\" src=\"/static/df126666647f8770d2c581b3773e814a/6244b/nodeport.png\" srcset=\"/static/df126666647f8770d2c581b3773e814a/c26ae/nodeport.png 158w,\n/static/df126666647f8770d2c581b3773e814a/6bdcf/nodeport.png 315w,\n/static/df126666647f8770d2c581b3773e814a/6244b/nodeport.png 446w\" sizes=\"(max-width: 446px) 100vw, 446px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</div>\n<h2>6.5.1 NodePort 생성</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>nodeport\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">nodePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30080</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app</code></pre></div>\n<ul>\n<li><code class=\"language-text\">spec.ports[].port</code>: ClusterIP에서 수신할 포트 번호</li>\n<li><code class=\"language-text\">spec.ports[].targetPort</code>: 목적지 컨테이너 포트 번호</li>\n<li><code class=\"language-text\">spec.ports[].nodePort</code>: 모든 쿠버네티스 노드에서 수신할 포트 번호. 명시적으로 지정하지 않으면 빈 포트 번호가 자동으로 할당된다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># NodePort 서비스 확인</span>\n$ kubectl apply <span class=\"token parameter variable\">-f</span> sample-nodeport.yaml\nservice/sample-nodeport created\n\n$ kubectl get services\nNAME                TYPE        CLUSTER-IP      EXTERNAL-IP             PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>          AGE\nkubernetes          ClusterIP   <span class=\"token number\">10.96</span>.0.1       <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                  <span class=\"token number\">443</span>/TCP          43d\nsample-nodeport     NodePort    <span class=\"token number\">10.96</span>.235.205   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                  <span class=\"token number\">8080</span>:30080/TCP   5s\n\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">dig</span> sample-nodeport.default.svc.cluster.local\n<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> QUESTION SECTION:\n<span class=\"token punctuation\">;</span>sample-nodeport.default.svc.cluster.local. IN A\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> ANSWER SECTION:\nsample-nodeport.default.svc.cluster.local. <span class=\"token number\">30</span> IN A <span class=\"token number\">10.96</span>.235.205\n\n<span class=\"token comment\"># Kind Cluster에서 요청</span>\n$ <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> http://localhost:30080\n<span class=\"token assign-left variable\">Host</span><span class=\"token operator\">=</span>localhost  <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/  <span class=\"token assign-left variable\">From</span><span class=\"token operator\">=</span>sample-deployment-65b84c8657-nfhch  <span class=\"token assign-left variable\">ClientIP</span><span class=\"token operator\">=</span><span class=\"token number\">172.18</span>.0.3  <span class=\"token assign-left variable\">XFF</span><span class=\"token operator\">=</span></code></pre></div>\n<h2>6.5.2 NodePort 주의점</h2>\n<p>NodePort에서 사용할 수 있는 포트 범위는 통상적으로 30000 ~ 32767(쿠버네티스 기본값)이며, 범위 외의 포트를 지정하려고 하면 에러가 발생한다.</br>\n또만, 당연하게도 같은 포트로 여러 서비스를 띄울 수 없다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>nodeport<span class=\"token punctuation\">-</span>fail\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">nodePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8888</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ kubectl apply <span class=\"token parameter variable\">-f</span> sample-nodeport-fail.yaml\nThe Service <span class=\"token string\">\"sample-nodeport-fail\"</span> is invalid: spec.ports<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>.nodePort: Invalid value: <span class=\"token number\">8888</span>: provided port is not <span class=\"token keyword\">in</span> the valid range. The range of valid ports is <span class=\"token number\">30000</span>-32767</code></pre></div>\n<h1>6.6 LoadBalancer</h1>\n<p>LoadBalancer 서비스는 서비스 환경에서 클러스터 외부로부터 트래픽을 수신할 때 가장 실용적이고 사용하기 편리한 서비스이다. LoadBalancer는 쿠버네티스 클러스터 외부의 로드 밸런서에 외부 통신이 가능한 가상 IP 주소를 엔드포인트로 할당할 수 있다. 외부 로드 밸런서를 사용하려면 쿠버네티스 클러스터가 구축된 인프라가 이 구조에 맞도록 설계되어 있어야 한다. 현재는 GCP/AWS/애저(Azhure)/OpenStack을 비롯한 클라우드 프로바이저가 LoadBalancer 서비스를 사용할 수 있는 환경을 제공하고 있다. Docker Desktop for Mac/Windows에서는 LoadBalancer 서비스를 생성하면 localhost(127.0.0.1)의 IP주소를 사용하여 접속할 수 있게 한다. 따라서 같은 포트 번호를 사용하여 여러 LoadBalancer 서비스를 생성할 수 없으므로 주의하자.</br>\nNodePort나 ExternalIP에서는 결국 하나의 쿠버네티스 노드에 할당된 IP주소로 통신하기 때문에 그 노드가 단일 장애점이 되어 버린다. 하지만 LoadBalancer의 경우 쿠버네티스 노드와 별도로 외부 로드 밸런서를 사용하기 때문에 노드 장애가 발생해도 크게 문제가 되지 않는다. 구조는 NodePort를 생성하고 클러스터 외부로 로드 밸런서에 쿠버네티스 노드로 밸런싱을 하는 형태이다. 쿠버네티스 노드에 장애가 발생한 경우에는 그 노드에 트래픽을 전송하지 않음으로써 자동으로 복구하게 되어 있다.</p>\n<div align=\"center\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 478px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/13133a7c5a73e7f3d438a7f7f2aa59a5/50978/loadbalancer.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 82.27848101265823%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADPUlEQVR42o2U+08bRxSF+f8rtVUiVZWqRE1aUtrmQRDgUAgYDNj4tX7iN16wzdpeg1/rfXhtf72zIWlafulKRzt798yZO/eembXyzYTDTJ9I3uTkAZHCgEPNYGM3wa/vz/nl3Sm/bcd5c5D7wvmHa8r8Hu2+BcsFa+bQ5cqYoXf/javbKcl8g3RRJ5lrBMiWW494AdewGE09lr7Pmuc4+J6L7/4HElstl7LoAn8+Z7VaBRPmrvOIq2KeI+O5CNozh445RTfG3PQmX9DuTWlc90llKiS0MvnLJu3umNZXHAU1r39v4X4WdCTDpjEiWzUEt2Rr8i63+VjQOeo5PDtM8u3rD/yerhG+tYhk6uTrXTIB3yBX73FrWsw9j7kSHA/H5Mo3XGRrUqc68WyDuFYnlKiymdF5dZpl/STLH7Eyb5JXHCVr8r/BRUZxa8QyNaqNDrZl4fvSlIE5CIqvZYvUKg0qeoJC65Cz4g7lmzCappGQ7LKFKNpViGhxl5oR5rKSo1KqEk8Xuay2GA9HLJSg63qyxWtOz2IUcgUOwtu8/PMp70I/k8gdcHYeJRLLE4tHiGo7bIZe8HrnmXyfk8tkOY5coLcH0hjvUw1VMR3bI3p2zl8HR2xs7PLkm5949XKL0N4xx+FjqtUGhx+P2NoO8/zHDX74/gVvNw8Ifdgnnc4gZhAN56EpMlCpLuRjsVwxu7sjHtqlmU4hvhGsAsuox7dt0vt7lKJRvJkd1GyhrOTNv+ryg6DqkCc/Voslfcsl0RmSlq0kr7skmgYpvUu6c0dO7GS780BICSg8ElSDIEMxscr/Snz1tj3jebzGk70k3+3GeLqfYr3YJWTYTMW7ihfsTOA/CAZN+ZyhJaThcMpkYjMYWTT7kqH47f1RnvWtc/ajJU7ERrrEJ9MZ44kVYGa7uJ4fvB1pTCCojpjeGXCWLKEVm5gjG89Vq3o4AnX8lguf3t2UZrNFLHpBIpGShmiUShUMo0fntot5P1VHT032grYHkPQ9cb2KBXEZK+G5LHAvmZvmPelSg1RFR6t3KDQ7cmp0mtcthqPZJ9v8H3hyCYzHFv3BmMK1XFuXbU5LLUo3A3qDKd2BRdcc8zdYjo+8syD65QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"loadbalancer\" title=\"\" src=\"/static/13133a7c5a73e7f3d438a7f7f2aa59a5/50978/loadbalancer.png\" srcset=\"/static/13133a7c5a73e7f3d438a7f7f2aa59a5/c26ae/loadbalancer.png 158w,\n/static/13133a7c5a73e7f3d438a7f7f2aa59a5/6bdcf/loadbalancer.png 315w,\n/static/13133a7c5a73e7f3d438a7f7f2aa59a5/50978/loadbalancer.png 478w\" sizes=\"(max-width: 478px) 100vw, 478px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</div>\n<h2>6.6.1 LoadBalancer 생성</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>lb\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> LoadBalancer\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">nodePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30082</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app</code></pre></div>\n<ul>\n<li><code class=\"language-text\">spec.ports[].port</code>: 로드 밸런서에 할당되는 가상 IP와 ClusterIP에서 수신할 포트 번호.</li>\n<li><code class=\"language-text\">spec.ports[].targetPort</code>: 목적지 컨테이너 포트 번호</li>\n<li><code class=\"language-text\">spec.ports[].nodePort</code>: 모든 쿠버네티스 노드 IP주소에서 수신할 포트 번호</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ kubectl apply <span class=\"token parameter variable\">-f</span> sample-lb.yaml\nservice/sample-lb created\n\n<span class=\"token comment\"># 서비스 확인</span>\n$ kubectl get services sample-lb <span class=\"token parameter variable\">-o</span> wide\nNAME        TYPE           CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>          AGE     SELECTOR\nsample-lb   LoadBalancer   <span class=\"token number\">10.96</span>.83.102   <span class=\"token operator\">&lt;</span>pending<span class=\"token operator\">></span>     <span class=\"token number\">8080</span>:30082/TCP   2m35s   <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>sample-app</code></pre></div>\n<p>LoadBalancer 생성 직후에는 가상 IP 할당이 완료되지 않아 pending 상태로 보이지만, 몇 초에서 수십 초 경이 지나면 생성이 완료된다. LoadBalancer 서비스를 생성하게 되면, 컨테이너 내부에서의 통신은 ClusterIP를 사용하므로 ClusterIP와 클러스터-파드간 통신에 관여하는 NodePort도 생성된다. (kind를 사용했을 경우 metalLB를 사용하여 추가적으로 서비스를 올려야 LoadBalancer 사용이 가능하다.)</p>\n<h2>6.6.2 로드 밸런서에 할당디는 가상 IP 정적 지정</h2>\n<p>실제 서비스 운영 환경에서는 외부로부터 요청을 수신하는 IP 주소에 대해 DNS 설정 등의 이유로 고정 IP를 사용하려는 경우가 많다. 이런 경우 <code class=\"language-text\">spec.loadBalancerIP</code>로 외부 LoadBalancer에서 사용하는 IP 주소를 지정할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>lb<span class=\"token punctuation\">-</span>fixip\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> LoadBalancer\n  <span class=\"token key atrule\">loadBalancerIP</span><span class=\"token punctuation\">:</span> 127.0.0.1\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app</code></pre></div>\n<h2>6.6.3 로드 밸런서 뱡화벽 정책 설정</h2>\n<p>LoadBalancer 서비스를 생성하면 기본적으로 외부로 완전 공개된다. GKE와 아마존 EKS에서는 LoadBalancer 서비스의 <code class=\"language-text\">spec.loadBalancerSourceRanges</code>에 접속을 허가하는 발신 측 네트워크를 지정하면 클러스터 밖의 외부 로드 밸런서에 클라우드 프로바이더가 제공하는 방화벽 기능을 사용하여 접속 제한을 설정할 수 있다. 지정하지 않을 경우, 0.0.0.0/0이 지정되어 전 세계에 공개된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>lb<span class=\"token punctuation\">-</span>fw\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> LoadBalancer\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">loadBalancerSourceRanges</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> 10.0.0.0/8</code></pre></div>\n<h1>6.7 그 외의 기능 (세션 어피니티 등)</h1>\n<h2>6.7.1 세션 어피니티</h2>\n<p>서비스에서는 세션 어피니티(Session Affinity)를 설정할 수 있다. 예를 들어, ClusterIP 서비스에서 활성화한 경우 ClusterIP로 보내진 트래픽은 서비스에 연결된 어느 하나의 파드에 전송된 후 다음 트래픽도 계속 같은 파드에 보내진다. 서비스에 대한 설정은 <code class=\"language-text\">spec.sessionAffinity</code>와 <code class=\"language-text\">spec.sessionAffinityConfig</code>을 사용한다. 현재 구현된 ClusterIP에서는 클라이언트 IP 주소(발신 측 IP 주소)를 바탕으로 목적지를 결정하게 된다. 이 세션 어피니티의 기능은 각 쿠버네티스 노드에 iptables로 구현되어 있으며, 최대 세션 고정 시간(<code class=\"language-text\">sessionAffinityConfig.clientIP.timeoutSeconds</code>)을 설정할 수 있다. 그리고 <code class=\"language-text\">spec.sesisonAffinity</code> 기본값은 0이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>session<span class=\"token punctuation\">-</span>affinity\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> LoadBalancer\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">-</span>port\n    <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n    <span class=\"token key atrule\">nodePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30084</span>\n  <span class=\"token key atrule\">sessionAffinity</span><span class=\"token punctuation\">:</span> ClientIP\n  <span class=\"token key atrule\">sessionAffinityConfig</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">clientIP</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># Session Affinity 생성</span>\n$ kubectl apply <span class=\"token parameter variable\">-f</span> sample-session-affinity.yaml\nservice/sample-session-affinity created\n\n<span class=\"token comment\"># 첫 번째 요청</span>\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">curl</span> http://sample-session-affinity.default.svc.cluster.local:8080\n<span class=\"token assign-left variable\">Host</span><span class=\"token operator\">=</span>sample-session-affinity.default.svc.cluster.local  <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/  <span class=\"token assign-left variable\">From</span><span class=\"token operator\">=</span>sample-deployment-65b84c8657-b5795  <span class=\"token assign-left variable\">ClientIP</span><span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.1.2  <span class=\"token assign-left variable\">XFF</span><span class=\"token operator\">=</span>\n\n<span class=\"token comment\"># 두 번째 요청</span>\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">curl</span> http://sample-session-affinity.default.svc.cluster.local:8080\n<span class=\"token assign-left variable\">Host</span><span class=\"token operator\">=</span>sample-session-affinity.default.svc.cluster.local  <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/  <span class=\"token assign-left variable\">From</span><span class=\"token operator\">=</span>sample-deployment-65b84c8657-b5795  <span class=\"token assign-left variable\">ClientIP</span><span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.1.2  <span class=\"token assign-left variable\">XFF</span><span class=\"token operator\">=</span>\n\n<span class=\"token comment\"># 세 번째 요청</span>\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">curl</span> http://sample-session-affinity.default.svc.cluster.local:8080\n<span class=\"token assign-left variable\">Host</span><span class=\"token operator\">=</span>sample-session-affinity.default.svc.cluster.local  <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/  <span class=\"token assign-left variable\">From</span><span class=\"token operator\">=</span>sample-deployment-65b84c8657-b5795  <span class=\"token assign-left variable\">ClientIP</span><span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.1.2  <span class=\"token assign-left variable\">XFF</span><span class=\"token operator\">=</span>\n\n<span class=\"token comment\"># 10초 뒤 요청</span>\n$ kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> sample-pod -- <span class=\"token function\">curl</span> http://sample-session-affinity.default.svc.cluster.local:8080\n<span class=\"token assign-left variable\">Host</span><span class=\"token operator\">=</span>sample-session-affinity.default.svc.cluster.local  <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/  <span class=\"token assign-left variable\">From</span><span class=\"token operator\">=</span>sample-deployment-65b84c8657-v244g  <span class=\"token assign-left variable\">ClientIP</span><span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.1.2  <span class=\"token assign-left variable\">XFF</span><span class=\"token operator\">=</span></code></pre></div>\n<p>NodePort나 LoadBalancer 레벨에서도 세션 어피니티를 활성화할 수 있으나, 같은 노드의 같은 ClientIP라도 같은 파드에 전송된다고 보장할 수 없으므로 잘 사용되지 않는다.</p>\n<h2>6.7.2 노드 간 통신 제외와 발신 측 IP 주소 유지</h2>\n<p>NodePort와 LoadBalancer 서비스에서 쿠버네티스 노드에 도착한 요청은 노드를 통해 파드에서 로드 밸런싱하게 되어 있으므로 불필요한 2단계 로드 밸런싱이 이루어진다. 예를 들어, LoadBalancer 서비스에서 로드 밸런서가 로드 밸런싱하여 노드에 도착한 요청은 노드를 통해 파드에도 로드 밸런싱되는 형태이다. 이 2단계 로드 밸런싱은 균일하게 요청을 분산하기에는 쉽지만, 불필요한 Latency Overhead가 발생하거나 밸런싱을 수행할 때 네트워크 주소 변환이 이루어져 발신 측 IP 주소가 유실되는 특징이 있다.</br></p>\n<p>반면 데몬셋은 하나의 노드에 하나의 파드가 배치되므로, 굳이 다른 노드의 파드에 전송하지 않고 같은 노드에만 통신하고 싶은 경우가 있다. 그런 경우 <code class=\"language-text\">spec.externalTrraficPolicy</code>를 이용할 수 있다. 단, ClusterIP에서는 사용할 수 없다.</p>\n<table>\n<thead>\n<tr>\n<th>externalTrafficPolicy 설정값</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Cluster(기본값)</td>\n<td>노드에 트래픽이 도착한 후 다른 노드에 있는 파드를 포함하여 다시 로드 밸런싱함으로써 파드 부하를 균등하게 분산.</td>\n</tr>\n<tr>\n<td>Local</td>\n<td>노드에 트래픽이 도착한 후 노드 간 로드 밸런싱을 하지 않는다.</td>\n</tr>\n</tbody>\n</table>\n<p><code class=\"language-text\">spec.externalTrafficPolicy</code>가 Cluster인 경우 앞서 설명한 바와 같고, Local인 경우 LoadBalancer 서비스와 NodePort 서비스 둘 다 외부에서 해당 노드에 도착한 요청은 그 노드상에 있는 파드에만 전송된다. 만약, 해당 노드상에 파드가 없다면 요청에 응답할 수 없다. LoadBalancer 서비스에서 사용하면 별도로 헬스 체크용 NodePort가 할당되기 때문에 파드가 존재하지 않는 노드에는 로드 밸런서에서 요청이 전송되지 않는다. 헬스 체크용 NodePort는 <code class=\"language-text\">spec.healthCheckNodePort</code>에서 설정할 수 있다. 이 설정은 LoadBalancer 서비스와 <code class=\"language-text\">externalTrafficPolicy</code>가 Local인 경우에만 설정 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>lb<span class=\"token punctuation\">-</span>local\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> LoadBalancer\n  <span class=\"token key atrule\">externalTrafficPolicy</span><span class=\"token punctuation\">:</span> Local\n  <span class=\"token key atrule\">healthCheckNodePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30086</span>\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http-port\"</span>\n    <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TCP\"</span>\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n    <span class=\"token key atrule\">nodePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30085</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample<span class=\"token punctuation\">-</span>app</code></pre></div>\n<h2>출처</h2>\n<p><a href=\"https://dev-youngjun.tistory.com/20\">https://dev-youngjun.tistory.com/20</a></p>","frontmatter":{"title":"[쿠버네티스 완벽 가이드] 13. 서비스 API 카테고리 (2) - NodePort, LoadBalancer, 그 외 서비스","date":"September 12, 2022","description":null}},"previous":{"fields":{"slug":"/web/jwt&paesto/"},"frontmatter":{"title":"[Web] JWT Token과 PASETO"}},"next":{"fields":{"slug":"/web/jwt&paesto/"},"frontmatter":{"title":"[Web] JWT Token과 PASETO"}}},"pageContext":{"id":"959e2e53-26c3-52e7-be44-df4578740b0f"}},"staticQueryHashes":["230163734","3589320610"],"slicesMap":{}}